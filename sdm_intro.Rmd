---
title: "Intro to species distribution modelling"
author: "Petr Keil"
date: "November 27, 2018"
output: 
  html_document: 
    highlight: tango
    number_sections: yes
    theme: cerulean
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introduction

This class is heavily based on [this intro](https://cran.r-project.org/web/packages/dismo/vignettes/sdm.pdf) to ```dismo``` package by Robert Hijmans and Jane Elith.

![](https://upload.wikimedia.org/wikipedia/commons/thumb/1/18/Bradypus.jpg/800px-Bradypus.jpg)


# Loading the data and packages

## Packages

```{r, message=FALSE, warning=FALSE}
library(dismo) # package for species distribution modelling
library(sdm) # another package for species distribution modelling
library(mgcv) # package for generalized additive models
library(maptools); data(wrld_simpl) # world boundaries
library(sp) # package for vector layers
library(rgeos)
library(raster) # package for raster layers
```

## Data

### Bradypus observations

```{r}
file <- paste(system.file(package="dismo"), "/ex/bradypus.csv", sep="")
bradypus <- read.table(file,  header=TRUE,  sep=',')
```

Let's convert the lat-long point data to ```spatialPoints``` class

```{r}
brad.pts <- SpatialPoints(coords = bradypus[, c('lon', 'lat')], 
                          proj4string = CRS("+proj=longlat +datum=WGS84"))

```

Plot the raw observational data

```{r, fig.height = 7}
plot(brad.pts)
plot(wrld_simpl, add=TRUE, border="darkgrey")
```


### Environmental predictors

They come from WorldClim 1.4 and WWF.

```{r}
files <- list.files(path=paste(system.file(package="dismo"), '/ex', sep=''), 
                    pattern='grd', 
                    full.names=TRUE)

predictors <- stack(files)
names(predictors) <- c("MeanT","MeanP","WetP","DryP","MaxT",
                       "MinT","TRange","WetT", "biome")
```

Let's plot the predictors

```{r, fig.width = 8}
plot(predictors)
```



# Prepare the data for modelling

## Mask for the pseudo-absence data

```{r}
x <- circles(brad.pts, d=400000, lonlat=TRUE) # 400 km diameter
pol <- polygons(x)

mask <- predictors[[1]]
v <- extract(mask, x@polygons, cellnumbers=T)
v <- do.call(rbind, v)
v <- unique(v[,1])
m <- mask
m[] <- NA
m[v] <- 1
m <- m
m[is.na(mask)] <- NA
```

```{r}
plot(m)
plot(wrld_simpl, add=TRUE, border="darkgrey")
```

## Put observations, pseudo-absences, and predictors together

```{r}
# presence data
set.seed(0)
pres.coords <- bradypus[, c('lon', 'lat')]
pres.pred <- extract(predictors, brad.pts)
pres <- rep(1, nrow(pres.pred))
pres.data <- data.frame(pres, pres.pred, pres.coords)
pres.data$biome <- as.factor(pres.data$biome)

# background data
abs.coords <- randomPoints(mask = m, n = 300, p = pres.coords)
colnames(abs.coords) <- c("lon", "lat")
abs.pred <- extract(predictors, abs.coords)
pres <- rep(0, nrow(abs.coords))
abs.data <- data.frame(pres, abs.pred, abs.coords)
abs.data$biome <- as.factor(abs.data$biome)

# all data
sdmdata <- rbind(pres.data, abs.data)
```

```{r}
summary(sdmdata)
```

Examine the resulting data points

```{r, fig.height = 7}
summary(sdmdata)

plot(lat ~ lon, data = sdmdata, col = as.factor(pres))
plot(wrld_simpl, add=TRUE, border="darkgrey")
```


## Training and testing datasets for crossvalidation


```{r}
test.id <- sort(sample(x = 1:nrow(sdmdata), size = 100))
train.id <- which(1:nrow(sdmdata) %in% test.id == FALSE)

test.data <- sdmdata[test.id,]
train.data <- sdmdata[train.id,]
```



![](https://upload.wikimedia.org/wikipedia/commons/thumb/2/2e/MC_Drei-Finger-Faultier.jpg/1920px-MC_Drei-Finger-Faultier.jpg)

Photo by Christian MehlfÃ¼hrer, CC-BY license, Wikimedia Commons



# Fitting a Generalized Linear Model


## Logistic binomial regression

```{r}
m.null <- glm(pres ~ 1, data=train.data, family = "binomial")

m.full <- glm(pres ~ MeanT + MeanP + WetP + 
              DryP + MaxT + MinT + TRange + WetT, 
              data=train.data, family = "binomial")

# step(m.full)

m.env <-  glm(pres ~ MeanP + DryP + MaxT + MinT + WetT, 
              data=train.data, family = "binomial")
```

## Logistic binomial regression with spatial component

```{r}
m.space <- gam(pres ~ s(lat, lon, bs="sos", k = 33), 
                    data=train.data, family = "binomial")

m.env.space <-  gam(pres ~ MeanP + DryP + MaxT + 
                    MinT + WetT + s(lat, lon, bs="sos", k = 33), 
                    data=train.data, family = "binomial")
```



![](https://upload.wikimedia.org/wikipedia/commons/thumb/3/31/SlothDWA.jpg/800px-SlothDWA.jpg)

Photo by Sergiodelgado, CC-BY-SA, Wikimedia Commons

# Model evaluation and maps of predictions

### Comparison of AIC and BIC

```{r}
AIC(m.null, m.full, m.env, m.env.space, m.space)
BIC(m.null, m.full, m.env, m.env.space, m.space)
```

### Comparison with test data

```{r}
m.env.prd <- predict(m.env, newdata = test.data, type = "response")
m.space.prd <- predict(m.space, newdata = test.data, type = "response")
m.env.space.prd <- predict(m.env.space, newdata = test.data, type = "response")
```

```{r, fig.height= 3}
par(mfrow=c(1,3))
roc(x = test.data$pres, p = m.env.prd)
roc(x = test.data$pres, p = m.space.prd)
roc(x = test.data$pres, p = m.env.space.prd)

```


### Mapping the predictions

```{r}
all.data <- as.data.frame(predictors)
all.data <- data.frame(all.data,
                       lon = coordinates(predictors)[, 'x'],
                       lat = coordinates(predictors)[, 'y'])
all.data$biome <- as.factor(all.data$biome)
```

```{r}
m.env.prd <- predict(m.env.space, newdata = all.data, 
                     type = "response", na.action = na.pass)

pred.raster <- predictors[[1]]
pred.raster[] <- as.vector(m.env.prd )
```

```{r, fig.height = 10, fig.width = 10}
plot(brad.pts)
plot(pred.raster, add=TRUE)
plot(brad.pts, add=TRUE)
plot(wrld_simpl, add=TRUE, border="darkgrey")
```